import { type NextPage } from "next";
import Head from "next/head";
import { useState } from "react";
import Map from "react-map-gl";
import { AddSurfSpotPopUp } from "../components/AddSurfSpotPopUp/AddSurfSpotPopUp";
import { MapController } from "../components/MapController/MapController";
import { MapMarkers } from "../components/MapMarkers/MapMarkers";
import { api } from "../utils/api";

const Home: NextPage = () => {
  const [addMode, setAddMode] = useState(true);
  const [addPopUp, setAddPopUp] = useState(false);
  const [addSpotCoords, setAddSpotCoords] = useState({ x: 0, y: 0 });

  const handleAddButtonClick = () =>
    addMode ? setAddMode(false) : setAddMode(true);
  const cursor = addMode ? "cell" : "pointer";

  const surfSpots = api.example.getAll.useQuery();

  const closeAddSurfSpotPopUp = () => setAddPopUp(false);

  return (
    <>
      <Head>
        <title>Create T3 App</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className="flex h-screen text-sm text-white">
        <Map
          mapStyle="mapbox://styles/mapbox/dark-v9"
          mapboxAccessToken={process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN}
          initialViewState={{
            latitude: 49.2,
            longitude: -2.22,
            zoom: 5,
          }}
          cursor={cursor}
          dragPan={!addMode}
          onClick={(info) => {
            if (addMode && !addPopUp) {
              setAddPopUp(true);
              setAddSpotCoords({ x: info.point.x, y: info.point.y });
            }
          }}
        >
          {surfSpots.data && <MapMarkers surfSpots={surfSpots.data} />}
        </Map>
        <MapController
          addMode={addMode}
          handleAddButtonClick={handleAddButtonClick}
        />
        {addPopUp && (
          <AddSurfSpotPopUp
            addSpotCoords={addSpotCoords}
            closeAddSurfSpotPopUp={closeAddSurfSpotPopUp}
          />
        )}
      </main>
    </>
  );
};

export default Home;
